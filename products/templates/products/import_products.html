{% extends 'products/base.html' %}

{% block title %}Импорт продуктов{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h2><i class="fas fa-file-import"></i> Импорт продуктов из CSV</h2>
            <p class="text-muted">Загрузите CSV файл с данными о продуктах для массового импорта в базу данных.</p>
            
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-upload"></i> Загрузка файла</h5>
                </div>
                <div class="card-body">
                    <form id="importForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">Выберите CSV файл</label>
                            <input type="file" class="form-control" id="csvFile" name="csv_file" accept=".csv" required>
                            <div class="form-text">Поддерживаются только файлы в формате CSV</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="importBtn">
                            <i class="fas fa-upload"></i> Импортировать продукты
                        </button>
                        
                        <a href="{% url 'products_list' %}" class="btn btn-secondary ms-2">
                            <i class="fas fa-arrow-left"></i> Назад к списку
                        </a>
                    </form>
                </div>
            </div>
            
            <!-- Результат импорта -->
            <div id="importResult" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Результат импорта</h5>
                    </div>
                    <div class="card-body">
                        <div id="resultContent"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Формат CSV файла</h5>
                </div>
                <div class="card-body">
                    <h6>Обязательные поля:</h6>
                    <ul class="list-unstyled">
                        <li><code>title</code> или <code>название</code> - название товара</li>
                        <li><code>price</code> или <code>цена</code> - цена товара</li>
                    </ul>
                    
                    <h6>Дополнительные поля:</h6>
                    <ul class="list-unstyled">
                        <li><code>description</code> или <code>описание</code> - описание</li>
                        <li><code>quantity</code> или <code>количество</code> - количество</li>
                        <li><code>condition</code> или <code>состояние</code> - состояние товара</li>
                        <li><code>manufacturer</code> или <code>производитель</code> - производитель</li>
                        <li><code>ean</code> или <code>EAN</code> - штрихкод</li>
                        <li><code>mpn</code> или <code>MPN</code> - артикул</li>
                        <li><code>weight</code> или <code>вес</code> - вес товара</li>
                        <li><code>images</code> или <code>изображения</code> - ссылки на изображения</li>
                    </ul>
                    
                    <h6>Состояния товара:</h6>
                    <ul class="list-unstyled small">
                        <li>новый, как новый, очень хорошее</li>
                        <li>удовлетворительное, восстановленный</li>
                        <li>с дефектом, б/у хорошее</li>
                    </ul>
                    
                    <div class="mt-3">
                        <a href="{% url 'import_logs' %}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-history"></i> История импортов
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-download"></i> Пример файла</h5>
                </div>
                <div class="card-body">
                    <p>Скачайте пример CSV файла для понимания формата:</p>
                    <button class="btn btn-outline-success btn-sm" onclick="downloadSample()">
                        <i class="fas fa-download"></i> Скачать пример
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const importForm = document.getElementById('importForm');
    const importBtn = document.getElementById('importBtn');
    const importResult = document.getElementById('importResult');
    const resultContent = document.getElementById('resultContent');
    
    importForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(importForm);
        const fileInput = document.getElementById('csvFile');
        
        if (!fileInput.files[0]) {
            alert('Пожалуйста, выберите файл');
            return;
        }
        
        // Показываем индикатор загрузки
        importBtn.disabled = true;
        importBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Импорт...';
        
        fetch('/import-products/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let html = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> ${data.message}</h6>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h4 class="text-success">${data.success_count}</h4>
                                <small class="text-muted">Успешно импортировано</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h4 class="text-danger">${data.error_count}</h4>
                                <small class="text-muted">Ошибок</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h4 class="text-info">${data.total_rows}</h4>
                                <small class="text-muted">Всего строк</small>
                            </div>
                        </div>
                    </div>
                `;
                
                if (data.errors && data.errors.length > 0) {
                    html += `
                        <div class="mt-3">
                            <h6>Ошибки:</h6>
                            <div class="alert alert-warning">
                                <ul class="mb-0">
                                    ${data.errors.map(error => `<li>${error}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="mt-3">
                        <a href="{% url 'products_list' %}" class="btn btn-primary">
                            <i class="fas fa-list"></i> Посмотреть импортированные товары
                        </a>
                        <a href="{% url 'import_logs' %}" class="btn btn-outline-info ms-2">
                            <i class="fas fa-history"></i> История импортов
                        </a>
                    </div>
                `;
                
                resultContent.innerHTML = html;
                importResult.style.display = 'block';
                
                // Очищаем форму
                importForm.reset();
                
            } else {
                resultContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Ошибка импорта</h6>
                        <p>${data.error}</p>
                    </div>
                `;
                importResult.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            resultContent.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> Ошибка</h6>
                    <p>Произошла ошибка при импорте файла</p>
                </div>
            `;
            importResult.style.display = 'block';
        })
        .finally(() => {
            // Восстанавливаем кнопку
            importBtn.disabled = false;
            importBtn.innerHTML = '<i class="fas fa-upload"></i> Импортировать продукты';
        });
    });
});

function downloadSample() {
    const csvContent = `title,price,description,quantity,condition,manufacturer,ean,mpn,weight,images
"Тестовый товар 1",29.99,"Описание товара 1",5,"новый","Производитель 1","1234567890123","MPN001",1.5,"https://example.com/image1.jpg,https://example.com/image2.jpg"
"Тестовый товар 2",49.99,"Описание товара 2",3,"как новый","Производитель 2","1234567890124","MPN002",2.0,"https://example.com/image3.jpg"
"Тестовый товар 3",19.99,"Описание товара 3",10,"очень хорошее","Производитель 3","1234567890125","MPN003",0.8,"https://example.com/image4.jpg"`;
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'sample_products.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}
